{% extends "base.html" %}

{% block title %}Dashboard - Investify{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <ul class="sidebar-nav">
            <li><a href="{{ url_for('dashboard') }}" class="active">
                <i class="fas fa-home"></i>
                Home
            </a></li>
            <li><a href="{{ url_for('dashboard') }}">
                <i class="fas fa-chart-bar"></i>
                Dashboard
            </a></li>
            <li><a href="{{ url_for('market') }}">
                <i class="fas fa-shopping-cart"></i>
                Market
            </a></li>
            <li><a href="{{ url_for('portfolio') }}">
                <i class="fas fa-briefcase"></i>
                Portfolio
            </a></li>
            <li><a href="{{ url_for('leaderboard') }}">
                <i class="fas fa-trophy"></i>
                Leaderboard
            </a></li>
            <li><a href="{{ url_for('achievements') }}">
                <i class="fas fa-medal"></i>
                Achievements
            </a></li>
            <li><a href="{{ url_for('tutorial') }}">
                <i class="fas fa-book-open"></i>
                Tutorial
            </a></li>
        </ul>
        
        <div class="quick-stats">
            <h3>Quick Stats</h3>
            <div class="stat">
                <span>Global Rank</span>
                <span>#{{ user.global_rank }}</span>
            </div>
            <div class="stat">
                <span>Friends</span>
                <span>{{ user.friends_count }}</span>
            </div>
            <div class="stat">
                <span>Achievements</span>
                <span>{{ user.achievements_count }}/{{ user.total_achievements }}</span>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="portfolio-value">
                <span>Portfolio Value</span>
                <div class="value" id="topBarPortfolioValue">${{ "%.2f"|format(user.portfolio_value) }}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="user-avatar" style="background: {{ user.avatar_color }}; cursor: pointer;" onclick="window.location.href='{{ url_for('profile') }}'">
                    {{ user.username[0].upper() }}
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </div>
        
        <!-- Welcome Section -->
        <div style="margin-bottom: 30px;">
            <h1 style="font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(135deg, #00b8ff, #00ff88); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Welcome back, {{ user.username }}!
            </h1>
            <p style="color: #cccccc; font-size: 1.1rem;">Ready to dominate the markets today?</p>
        </div>
        
        <!-- Portfolio Overview -->
        <div style="margin-bottom: 30px;">
            <h2 style="color: #00b8ff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-clock"></i>
                Portfolio Overview
            </h2>
            <div class="dashboard-grid">
                <div class="dashboard-card" style="position: relative;">
                    <div class="card-title">Total Portfolio Value</div>
                    <div class="card-value" id="dashboardPortfolioValue">${{ "%.2f"|format(user.portfolio_value) }}</div>
                    <div class="card-subtitle">Current total</div>
                </div>
                
                <div class="dashboard-card" style="position: relative;">
                    <div class="card-title">Cash Balance</div>
                    <div class="card-value" id="dashboardCashBalance" style="color: #00ff88;">${{ "%.2f"|format(user.cash_balance) }}</div>
                    <div class="card-subtitle">Money available to trade</div>
                </div>
                
                <div class="dashboard-card" style="position: relative;">
                    <div class="card-title">Stock Holdings Value</div>
                    <div class="card-value" id="dashboardStockValue" style="color: #9d4edd;">$0.00</div>
                    <div class="card-subtitle">Value of owned stocks</div>
                </div>
                
                <div class="dashboard-card" style="position: relative;">
                    <div class="card-title">Holdings</div>
                    <div class="card-value" id="dashboardHoldingsCount">
                        <i class="fas fa-square" style="font-size: 16px; margin-right: 5px; color: #888;"></i>
                        0
                    </div>
                    <div class="card-subtitle">Stocks</div>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div style="margin-bottom: 30px;">
            <div class="dashboard-grid">
                <div class="dashboard-card" style="position: relative;">
                    <i class="fas fa-dollar-sign card-icon" style="color: #00ff88;"></i>
                    <div class="card-title">Buying Power</div>
                    <div class="card-value">${{ "%.2f"|format(user.cash_balance) }}</div>
                    <div class="card-subtitle">Available to trade</div>
                </div>
                
                <div class="dashboard-card" style="position: relative;">
                    <i class="fas fa-chart-line card-icon" style="color: #00b8ff;"></i>
                    <div class="card-title">Total Return</div>
                    <div class="card-value" style="color: #00ff88;">+0.0%</div>
                    <div class="card-subtitle">Since you started</div>
                </div>
                
                <div class="dashboard-card" style="position: relative;">
                    <i class="fas fa-trophy card-icon" style="color: #9d4edd;"></i>
                    <div class="card-title">Global Rank</div>
                    <div class="card-value">#{{ user.global_rank }}</div>
                    <div class="card-subtitle">Keep climbing!</div>
                </div>
                
                <div class="dashboard-card" style="position: relative;">
                    <i class="fas fa-bullseye card-icon" style="color: #ff6b6b;"></i>
                    <div class="card-title">Trading Streak</div>
                    <div class="card-value">0 days</div>
                    <div class="card-subtitle">Consistent trading</div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="margin-bottom: 30px;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <a href="{{ url_for('market') }}" class="btn btn-primary" style="padding: 15px 30px;">
                    <i class="fas fa-play"></i>
                    Start Trading
                </a>
                <a href="{{ url_for('portfolio') }}" class="btn btn-secondary" style="padding: 15px 30px;">
                    <i class="fas fa-briefcase"></i>
                    View Portfolio
                </a>
                <a href="{{ url_for('tutorial') }}" class="btn btn-secondary" style="padding: 15px 30px;">
                    <i class="fas fa-book-open"></i>
                    Learn More
                </a>
                <a href="{{ url_for('leaderboard') }}" class="btn btn-secondary" style="padding: 15px 30px;">
                    <i class="fas fa-users"></i>
                    Compete
                </a>
                <a href="{{ url_for('achievements') }}" class="btn btn-secondary" style="padding: 15px 30px;">
                    <i class="fas fa-medal"></i>
                    Achievements
                </a>
            </div>
        </div>
        
        <!-- Recent Trades & Market Insights -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <!-- Recent Trades -->
            <div>
                <h2 style="color: #00b8ff; margin-bottom: 20px;">Recent Trades</h2>
                <div class="dashboard-card">
                    <div id="recentTradesList">
                        <!-- Recent trades will be populated here -->
                    </div>
                    
                    <div id="noTradesMessage" style="text-align: center; padding: 40px;">
                        <p style="color: #cccccc; margin-bottom: 20px;">No trades yet</p>
                        <a href="{{ url_for('market') }}" class="btn btn-primary">Make Your First Trade</a>
                    </div>
                </div>
            </div>
            
            <!-- Market Insights -->
            <div>
                <h2 style="color: #00ff88; margin-bottom: 20px;">Market Insights</h2>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="dashboard-card">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-lightbulb" style="color: #9d4edd;"></i>
                            <span style="color: white; font-weight: 500;">Did You Know?</span>
                        </div>
                        <p style="color: #cccccc; line-height: 1.5;">Diversification helps reduce portfolio risk by spreading investments across different asset classes.</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-check-circle" style="color: #00ff88;"></i>
                            <span style="color: white; font-weight: 500;">Market Tip:</span>
                        </div>
                        <p style="color: #cccccc; line-height: 1.5;">Dollar-cost averaging can help reduce the impact of market volatility on your investments.</p>
                    </div>
                    
                    <div class="dashboard-card">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-bullseye" style="color: #ff6b6b;"></i>
                            <span style="color: white; font-weight: 500;">Strategy:</span>
                        </div>
                        <p style="color: #cccccc; line-height: 1.5;">Consider both growth and value stocks for a balanced portfolio approach.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load real portfolio data for dashboard
function loadDashboardData() {
    fetch('/get_portfolio_data')
        .then(response => response.json())
        .then(data => {
            const stats = data.portfolio_stats;
            
            // Update portfolio value (cash + stock holdings)
            document.getElementById('dashboardPortfolioValue').textContent = `$${stats.total_value.toFixed(2)}`;
            document.getElementById('topBarPortfolioValue').textContent = `$${stats.total_value.toFixed(2)}`;
            
            // Update cash balance (get from user data)
            fetch('/get_user_data')
                .then(response => response.json())
                .then(userData => {
                    document.getElementById('dashboardCashBalance').textContent = `$${userData.cash_balance.toFixed(2)}`;
                    
                    // Update stock holdings value (portfolio value - cash balance)
                    const stockValue = stats.total_value - userData.cash_balance;
                    document.getElementById('dashboardStockValue').textContent = `$${stockValue.toFixed(2)}`;
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                });
            
            // Update holdings count
            document.getElementById('dashboardHoldingsCount').innerHTML = `<i class="fas fa-square" style="font-size: 16px; margin-right: 5px; color: #888;"></i>${stats.holdings_count}`;
            
            // Update recent trades
            updateRecentTrades(data.transactions);
        })
        .catch(error => {
            console.error('Error loading dashboard data:', error);
        });
}

// Update recent trades display
function updateRecentTrades(transactions) {
    const tradesList = document.getElementById('recentTradesList');
    const noTradesMessage = document.getElementById('noTradesMessage');
    
    if (!transactions || transactions.length === 0) {
        tradesList.style.display = 'none';
        noTradesMessage.style.display = 'block';
        return;
    }
    
    tradesList.style.display = 'block';
    noTradesMessage.style.display = 'none';
    
    tradesList.innerHTML = transactions.slice(0, 5).map(transaction => {
        const actionColor = transaction.action === 'BUY' ? '#00ff88' : '#ff6b6b';
        const actionIcon = transaction.action === 'BUY' ? 'fa-arrow-up' : 'fa-arrow-down';
        
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 30px; height: 30px; border-radius: 50%; background: ${actionColor}; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                        <i class="fas ${actionIcon}"></i>
                    </div>
                    <div>
                        <div style="font-weight: bold; color: white;">${transaction.action} ${transaction.symbol}</div>
                        <div style="color: #cccccc; font-size: 0.8rem;">${transaction.shares} shares @ $${transaction.price.toFixed(2)}</div>
                    </div>
                </div>
                <div style="text-align: right; color: #888; font-size: 0.8rem;">
                    ${transaction.date}
                </div>
            </div>
        `;
    }).join('');
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});
</script>
{% endblock %} 